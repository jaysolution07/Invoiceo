<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Assistant Devis</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f5f7fb}
.header{background:#2563eb;color:white;padding:20px;font-size:20px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:20px}
button{background:#2563eb;color:white;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;margin-right:10px;margin-top:10px}
input,select{padding:8px;margin:4px 0;width:100%}
.line{display:flex;gap:10px;align-items:center}
.deleteBtn{background:#ef4444}
.clearBtn{background:#f59e0b}
.totals{background:#f1f5f9;padding:15px;border-radius:8px;margin-top:10px}
.saveBtn{background:#16a34a}
</style>
</head>

<body>

<div class="header">ðŸŽ¤ Assistant devis</div>

<div class="container">

<div class="card">
<button onclick="startVocal()">ðŸŽ¤ Micro</button>
<button onclick="stopVocal()">ðŸ›‘ Stop</button>
<p id="status"></p>
</div>

<div class="card">

<label>Client</label>
<select id="client"></select>

<h3>Lignes</h3>
<div id="lines"></div>

<button onclick="addLine()">âž• Ajouter ligne</button>
<button class="clearBtn" onclick="clearAll()">ðŸ§¹ Tout effacer</button>

<label>Remise (%)</label>
<input id="remise" oninput="calculate()">

<label>TVA (%)</label>
<input id="tva" oninput="calculate()">

<div class="totals">
<div>Total HT : <b id="totalHT">0 â‚¬</b></div>
<div>Montant remise : <b id="montantRemise">0 â‚¬</b></div>
<div>Total HT aprÃ¨s remise : <b id="totalApresRemise">0 â‚¬</b></div>
<div>Montant TVA : <b id="montantTVA">0 â‚¬</b></div>
<div>Total TTC : <b id="totalTTC">0 â‚¬</b></div>
</div>

<button class="saveBtn" onclick="saveDevis()">ðŸ’¾ Enregistrer le devis</button>

</div>
</div>

<script>

const CLIENTS_API="https://script.google.com/macros/s/AKfycbyy763BTRzWHbYDzuDJev1j8G4taqviqYqAcj8Q15vYR7USmiMGhpqAhq_fuv97P3qq/exec?clients=1";
const SAVE_API="https://script.google.com/macros/s/AKfycbyy763BTRzWHbYDzuDJev1j8G4taqviqYqAcj8Q15vYR7USmiMGhpqAhq_fuv97P3qq/exec";

let devis={client:"",lignes:[],remise:0,tva:0};
let recognition;

// ===== CLIENT LIST =====
fetch(CLIENTS_API)
.then(r=>r.json())
.then(data=>{
  data.forEach(c=>{
    let opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    client.appendChild(opt);
  });
});

// ===== RENDER =====
function render(){
  lines.innerHTML="";
  devis.lignes.forEach((l,i)=>{
    lines.innerHTML+=`
      <div class="line">
        <input value="${l.designation}" onchange="devis.lignes[${i}].designation=this.value">
        <input type="number" value="${l.quantite}" onchange="devis.lignes[${i}].quantite=this.value;calculate()">
        <input type="number" value="${l.prix}" onchange="devis.lignes[${i}].prix=this.value;calculate()">
        <button class="deleteBtn" onclick="deleteLine(${i})">âœ–</button>
      </div>
    `;
  });
  calculate();
}

// ===== CALCULS =====
function calculate(){
  let totalHT=0;
  devis.lignes.forEach(l=>{ totalHT+=Number(l.quantite)*Number(l.prix); });

  let remiseVal=Number(remise.value)||0;
  let montantRemise=totalHT*(remiseVal/100);
  let totalApres=totalHT-montantRemise;

  let tvaVal=Number(tva.value)||0;
  let montantTVA=totalApres*(tvaVal/100);
  let totalTTC=totalApres+montantTVA;

  totalHTEl(totalHT);
  montantRemiseEl(montantRemise);
  totalApresRemiseEl(totalApres);
  montantTVAEl(montantTVA);
  totalTTCEl(totalTTC);
}

function totalHTEl(v){totalHT.textContent=v.toFixed(2)+" â‚¬";}
function montantRemiseEl(v){montantRemise.textContent=v.toFixed(2)+" â‚¬";}
function totalApresRemiseEl(v){totalApresRemise.textContent=v.toFixed(2)+" â‚¬";}
function montantTVAEl(v){montantTVA.textContent=v.toFixed(2)+" â‚¬";}
function totalTTCEl(v){totalTTC.textContent=v.toFixed(2)+" â‚¬";}

// ===== LIGNES =====
function addLine(){ devis.lignes.push({designation:"",quantite:1,prix:0}); render(); }
function deleteLine(i){ devis.lignes.splice(i,1); render(); }
function clearAll(){ devis={client:"",lignes:[],remise:0,tva:0}; client.value=""; remise.value=""; tva.value=""; render(); }

// ===== SAVE =====
function saveDevis(){

  let payload={
    client:client.value,
    lignes:devis.lignes,
    remise:remise.value,
    tva:tva.value,
    totalHT:totalHT.textContent,
    totalTTC:totalTTC.textContent
  };

  fetch(SAVE_API,{method:"POST",body:JSON.stringify(payload)})
  .then(()=>alert("âœ… Devis enregistrÃ© dans Sheets"))
  .catch(()=>alert("âŒ Erreur enregistrement"));
}

// ===== VOCAL =====
function startVocal(){
  recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.lang="fr-FR";
  recognition.continuous=true;
  recognition.start();

  recognition.onresult=e=>{
    let text=e.results[e.results.length-1][0].transcript.toLowerCase();
    status.innerText=text;

    let clientMatch=text.match(/client\s+(.+)/);
    if(clientMatch){
      let nom=clientMatch[1].replace("monsieur","").replace("madame","").trim();
      client.value=nom;
    }

    const regex=/(radiateur|chauffage|prestation|travaux)\D*(\d+)/g;
    let match;
    while((match=regex.exec(text))!==null){
      devis.lignes.push({designation:match[1],quantite:1,prix:match[2]});
    }

    let rem=text.match(/remise\s*(\d+)/);
    if(rem){remise.value=rem[1];}

    let tv=text.match(/tva\s*(\d+)/);
    if(tv){tva.value=tv[1];}

    render();
  };
}

function stopVocal(){ if(recognition) recognition.stop(); }

</script>
</body>
</html>
