<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>INVOICEO</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:#eef2f7;
  color:#1f2937;
}

/* HEADER PREMIUM */
.header{
  background:linear-gradient(135deg,#2563eb,#1e3a8a);
  color:white;
  padding:18px 26px;
  display:flex;
  align-items:center;
  gap:14px;
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  position:sticky;
  top:0;
  z-index:10;
}
.header img{
  height:55px;
  animation:floatLogo 4s ease-in-out infinite;
}
.header span{
  font-size:22px;
  font-weight:600;
  letter-spacing:1px;
}
@keyframes floatLogo{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-5px)}
}

/* LAYOUT */
.container{
  max-width:1000px;
  margin:30px auto;
  padding:0 20px;
}

/* CARDS PREMIUM */
.card{
  background:white;
  padding:22px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
  margin-bottom:22px;
  transition:0.2s;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 32px rgba(0,0,0,0.12);
}

/* INPUTS */
input{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  width:100%;
  font-size:14px;
  transition:0.2s;
}
input:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,0.15);
}

/* BUTTONS */
button{
  background:#2563eb;
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:500;
  transition:0.2s;
}
button:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(37,99,235,0.35);
}

.deleteBtn{background:#ef4444}
.clearBtn{background:#f59e0b}
.saveBtn{background:#16a34a}

/* TOTAL BOX */
.totals{
  background:#f8fafc;
  padding:18px;
  border-radius:12px;
  margin-top:12px;
  border:1px solid #e5e7eb;
}

/* FLEX LINE */
.line{
  display:flex;
  gap:12px;
  align-items:center;
}

/* SUGGESTIONS */
.suggestion{
  padding:8px;
  border-radius:6px;
  cursor:pointer;
}
.suggestion:hover{
  background:#eef2ff;
}
</style>
</head>

<body>

<div class="header">
  <img src="logo.png" alt="Invoiceo logo">
  <span>INVOICEO</span>
</div>

<div class="container">

<!-- HOME -->
<div id="homePage" class="card">
<h3>Menu principal</h3>
<button onclick="showPage('devisPage')">üìÑ Cr√©er devis</button>
<button onclick="showPage('clientPage')">‚ûï Ajouter client</button>
</div>

<!-- CLIENT -->
<div id="clientPage" class="card hidden">
<h3>Ajouter un client</h3>
<input id="c_nom" placeholder="Nom">
<input id="c_adresse" placeholder="Adresse">
<input id="c_mail" placeholder="Email">
<input id="c_tel" placeholder="T√©l√©phone">
<button class="saveBtn" onclick="saveClient()">üíæ Enregistrer</button>
<button onclick="showPage('homePage')">‚¨ÖÔ∏è Retour</button>
</div>

<!-- DEVIS -->
<div id="devisPage" class="card hidden">
<button onclick="showPage('homePage')">‚¨ÖÔ∏è Retour menu</button>
<h3>Cr√©er un devis</h3>

<div class="card">
<button onclick="startVocal()">üé§ Micro</button>
<button onclick="stopVocal()">üõë Stop</button>
<p id="status"></p>
</div>

<label>Client</label>
<input id="clientInput" placeholder="Tapez pour rechercher...">
<div id="clientSuggestions"></div>

<h3>Lignes</h3>
<div id="lines"></div>

<button onclick="addLine()">‚ûï Ajouter ligne</button>
<button class="clearBtn" onclick="clearAll()">üßπ Tout effacer</button>

<label>Remise (%)</label>
<input id="remise" oninput="calculate()">

<label>TVA (%)</label>
<input id="tva" oninput="calculate()">

<div class="totals">
<div>Total HT : <b id="totalHT">0 ‚Ç¨</b></div>
<div>Montant remise : <b id="montantRemise">0 ‚Ç¨</b></div>
<div>Total HT apr√®s remise : <b id="totalApresRemise">0 ‚Ç¨</b></div>
<div>Montant TVA : <b id="montantTVA">0 ‚Ç¨</b></div>
<div>Total TTC : <b id="totalTTC">0 ‚Ç¨</b></div>
</div>

<button class="saveBtn" onclick="saveDevis()">üíæ Enregistrer devis</button>

</div>
</div>

<script>

const WEBAPP_URL="https://script.google.com/macros/s/AKfycbyy763BTRzWHbYDzuDJev1j8G4taqviqYqAcj8Q15vYR7USmiMGhpqAhq_fuv97P3qq/exec";

// NAVIGATION
function showPage(id){
homePage.classList.add("hidden");
clientPage.classList.add("hidden");
devisPage.classList.add("hidden");
document.getElementById(id).classList.remove("hidden");
}

// ================= CLIENT SEARCH =================
let clientsList=[];

function loadClients(){
  fetch(WEBAPP_URL+"?clients=1")
  .then(r=>r.json())
  .then(data=>{
    clientsList = data || [];
  })
  .catch(()=>alert("Erreur chargement clients"));
}

loadClients();

clientInput.addEventListener("input",()=>{
const value=clientInput.value.toLowerCase();
clientSuggestions.innerHTML="";
if(!value) return;

clientsList
.filter(c=>c.toLowerCase().includes(value))
.forEach(c=>{
const div=document.createElement("div");
div.textContent=c;
div.className="suggestion";
div.onclick=()=>{
clientInput.value=c;
clientSuggestions.innerHTML="";
};
clientSuggestions.appendChild(div);
});
});

// ================= SAVE CLIENT =================
function saveClient(){
fetch(WEBAPP_URL,{
method:"POST",
body:JSON.stringify({type:"client",nom:c_nom.value,adresse:c_adresse.value,mail:c_mail.value,tel:c_tel.value}),
mode:"no-cors"
});
alert("Client ajout√©");
}

// ================= DEVIS =================
let devis={lignes:[]};

function render(){
lines.innerHTML="";
devis.lignes.forEach((l,i)=>{
lines.innerHTML+=`
<div class="line">
<input value="${l.designation}" oninput="devis.lignes[${i}].designation=this.value">
<input type="number" value="${l.quantite}" oninput="devis.lignes[${i}].quantite=this.value;calculate()">
<input type="number" value="${l.prix}" oninput="devis.lignes[${i}].prix=this.value;calculate()">
<button class="deleteBtn" onclick="deleteLine(${i})">‚úñ</button>
</div>`;
});
calculate();
}

function addLine(){devis.lignes.push({designation:"",quantite:1,prix:0});render();}
function deleteLine(i){devis.lignes.splice(i,1);render();}
function clearAll(){devis={lignes:[]};render();}

// ================= CALCUL =================
function calculate(){
let ht=0;
devis.lignes.forEach(l=>ht+=Number(l.quantite||0)*Number(l.prix||0));

let r=Number(remise.value)||0;
let remVal=ht*(r/100);
let htApres=ht-remVal;

let t=Number(tva.value)||0;
let tvaVal=htApres*(t/100);
let ttc=htApres+tvaVal;

totalHT.textContent=ht.toFixed(2)+" ‚Ç¨";
montantRemise.textContent=remVal.toFixed(2)+" ‚Ç¨";
totalApresRemise.textContent=htApres.toFixed(2)+" ‚Ç¨";
montantTVA.textContent=tvaVal.toFixed(2)+" ‚Ç¨";
totalTTC.textContent=ttc.toFixed(2)+" ‚Ç¨";
}

// ================= SAVE DEVIS =================
function saveDevis(){
fetch(WEBAPP_URL,{
method:"POST",
body:JSON.stringify({
type:"devis",
client:clientInput.value,
lignes:devis.lignes,
remise:remise.value,
tva:tva.value
}),
mode:"no-cors"
});
alert("Devis enregistr√©");
}

// ================= VOICE =================
let recognition;
let lastProcessedText = "";

// ===== CORRECTION TEXTE GENERIQUE =====
function cleanSpeechText(text){
return text
.replace(/[‚Ç¨]/g,"")
.replace(/\s+/g," ")
.replace(/^\s+|\s+$/g,"")
.replace(/\b(euh|heu|alors|donc|voil√†)\b/g,"")
.trim();
}

// ===== CAPITALISATION =====
function capitalize(str){
return str.charAt(0).toUpperCase() + str.slice(1);
}

function startVocal(){

recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "fr-FR";
recognition.continuous = true;
recognition.interimResults = false;
recognition.start();

recognition.onresult = e => {

let text = e.results[e.results.length-1][0].transcript.toLowerCase();

if(text === lastProcessedText) return;
lastProcessedText = text;

status.innerText = text;

// ===== REMISE =====
const remMatch = text.match(/remise\s*(\d+)/);
if(remMatch) remise.value = remMatch[1];

// ===== TVA =====
const tvaMatch = text.match(/tva\s*(\d+)/);
if(tvaMatch) tva.value = tvaMatch[1];

// ===== TEXTE NETTOY√â =====
let cleanText = text
.replace(/remise\s*\d+/g,"")
.replace(/tva\s*\d+/g,"");

cleanText = cleanSpeechText(cleanText);

// ===== SPLIT LIGNES =====
const blocs = cleanText.split("suivant");

blocs.forEach(bloc=>{
bloc = bloc.trim();
if(!bloc) return;

const numbers = bloc.match(/\d+/g);

let designation = bloc
.replace(/\d+/g,"")
.trim();

designation = capitalize(cleanSpeechText(designation));

if(!designation) return;

let quantite = 1;
let prix = 0;

if(numbers){
if(numbers.length === 1){
prix = numbers[0];
}
if(numbers.length >= 2){
quantite = numbers[0];
prix = numbers[1];
}
}

devis.lignes.push({ designation, quantite, prix });

});

render();
};

}

function stopVocal(){
if(recognition){
recognition.stop();
lastProcessedText = "";
}
}

</script>
</body>
</html>




