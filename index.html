let recognition;
let lastProcessedText = "";

// ===== CORRECTION TEXTE GENERIQUE =====
function cleanSpeechText(text){

  return text
    .replace(/[€]/g,"")
    .replace(/\s+/g," ")
    .replace(/^\s+|\s+$/g,"")
    .replace(/\b(euh|heu|alors|donc|voilà)\b/g,"")
    .trim();
}

// ===== CAPITALISATION =====
function capitalize(str){
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function startVocal(){

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "fr-FR";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.start();

  recognition.onresult = e => {

    let text = e.results[e.results.length-1][0].transcript.toLowerCase();

    if(text === lastProcessedText) return;
    lastProcessedText = text;

    status.innerText = text;

    // ===== REMISE =====
    const remMatch = text.match(/remise\s*(\d+)/);
    if(remMatch) remise.value = remMatch[1];

    // ===== TVA =====
    const tvaMatch = text.match(/tva\s*(\d+)/);
    if(tvaMatch) tva.value = tvaMatch[1];

    // ===== TEXTE NETTOYÉ =====
    let cleanText = text
      .replace(/remise\s*\d+/g,"")
      .replace(/tva\s*\d+/g,"");

    cleanText = cleanSpeechText(cleanText);

    // ===== SPLIT LIGNES =====
    const blocs = cleanText.split("suivant");

    blocs.forEach(bloc=>{

      bloc = bloc.trim();
      if(!bloc) return;

      const numbers = bloc.match(/\d+/g);

      let designation = bloc
        .replace(/\d+/g,"")
        .trim();

      designation = capitalize(cleanSpeechText(designation));

      if(!designation) return;

      let quantite = 1;
      let prix = 0;

      if(numbers){
        if(numbers.length === 1){
          prix = numbers[0];
        }
        if(numbers.length >= 2){
          quantite = numbers[0];
          prix = numbers[1];
        }
      }

      devis.lignes.push({
        designation,
        quantite,
        prix
      });

    });

    render();
  };
}

function stopVocal(){
  if(recognition){
    recognition.stop();
    lastProcessedText = "";
  }
}
