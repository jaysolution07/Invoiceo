<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Assistant Gestion</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f5f7fb}
.header{background:#2563eb;color:white;padding:20px;font-size:20px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:20px}
button{background:#2563eb;color:white;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;margin:5px}
input,select{padding:8px;margin:4px 0;width:100%}
.line{display:flex;gap:10px;align-items:center}
.deleteBtn{background:#ef4444}
.clearBtn{background:#f59e0b}
.saveBtn{background:#16a34a}
.totals{background:#f1f5f9;padding:15px;border-radius:8px;margin-top:10px}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">ğŸ“Š Assistant gestion</div>

<div class="container">

<div id="homePage" class="card">
<h3>Menu principal</h3>
<button onclick="showPage('devisPage')">ğŸ“„ CrÃ©er devis</button>
<button onclick="showPage('clientPage')">â• Ajouter client</button>
</div>

<div id="clientPage" class="card hidden">
<h3>Ajouter un client</h3>
<input id="c_nom" placeholder="Nom">
<input id="c_adresse" placeholder="Adresse">
<input id="c_mail" placeholder="Email">
<input id="c_tel" placeholder="TÃ©lÃ©phone">
<button class="saveBtn" onclick="saveClient()">ğŸ’¾ Enregistrer</button>
<button onclick="showPage('homePage')">â¬…ï¸ Retour</button>
</div>

<div id="devisPage" class="card hidden">

<button onclick="showPage('homePage')">â¬…ï¸ Retour menu</button>
<h3>CrÃ©er un devis</h3>

<div class="card">
<button onclick="startVocal()">ğŸ¤ Micro</button>
<button onclick="stopVocal()">ğŸ›‘ Stop</button>
<p id="status"></p>
</div>

<label>Client</label>
<select id="client"></select>

<h3>Lignes</h3>
<div id="lines"></div>

<button onclick="addLine()">â• Ajouter ligne</button>
<button class="clearBtn" onclick="clearAll()">ğŸ§¹ Tout effacer</button>

<label>Remise (%)</label>
<input id="remise" oninput="calculate()">

<label>TVA (%)</label>
<input id="tva" oninput="calculate()">

<div class="totals">
<div>Total HT : <b id="totalHT">0 â‚¬</b></div>
<div>Montant remise : <b id="montantRemise">0 â‚¬</b></div>
<div>Total HT aprÃ¨s remise : <b id="totalApresRemise">0 â‚¬</b></div>
<div>Montant TVA : <b id="montantTVA">0 â‚¬</b></div>
<div>Total TTC : <b id="totalTTC">0 â‚¬</b></div>
</div>

<button class="saveBtn" onclick="saveDevis()">ğŸ’¾ Enregistrer devis</button>

</div>
</div>

<script>

const WEBAPP_URL="https://script.google.com/macros/s/AKfycbyy763BTRzWHbYDzuDJev1j8G4taqviqYqAcj8Q15vYR7USmiMGhpqAhq_fuv97P3qq/exec";

// NAV
function showPage(id){
  homePage.classList.add("hidden");
  clientPage.classList.add("hidden");
  devisPage.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

// LOAD CLIENTS
fetch(WEBAPP_URL+"?clients=1")
.then(r=>r.json())
.then(data=>{
  data.forEach(c=>{
    let opt=document.createElement("option");
    opt.value=c;
    opt.textContent=c;
    client.appendChild(opt);
  });
});

// SAVE CLIENT
function saveClient(){
  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({type:"client",nom:c_nom.value,adresse:c_adresse.value,mail:c_mail.value,tel:c_tel.value}),
    mode:"no-cors"
  });
  alert("Client ajoutÃ©");
}

// DEVIS
let devis={lignes:[]};

function render(){
  lines.innerHTML="";
  devis.lignes.forEach((l,i)=>{
    lines.innerHTML+=`
      <div class="line">
        <input value="${l.designation}" oninput="devis.lignes[${i}].designation=this.value">
        <input type="number" value="${l.quantite}" oninput="devis.lignes[${i}].quantite=this.value;calculate()">
        <input type="number" value="${l.prix}" oninput="devis.lignes[${i}].prix=this.value;calculate()">
        <button class="deleteBtn" onclick="deleteLine(${i})">âœ–</button>
      </div>`;
  });
  calculate();
}

function addLine(){ devis.lignes.push({designation:"",quantite:1,prix:0}); render(); }
function deleteLine(i){ devis.lignes.splice(i,1); render(); }
function clearAll(){ devis={lignes:[]}; render(); }

// CALCUL
function calculate(){
  let ht=0;
  devis.lignes.forEach(l=>ht+=Number(l.quantite)*Number(l.prix));

  let r=Number(remise.value)||0;
  let remVal=ht*(r/100);
  let htApres=ht-remVal;

  let t=Number(tva.value)||0;
  let tvaVal=htApres*(t/100);
  let ttc=htApres+tvaVal;

  document.getElementById("totalHT").textContent=ht.toFixed(2)+" â‚¬";
  document.getElementById("montantRemise").textContent=remVal.toFixed(2)+" â‚¬";
  document.getElementById("totalApresRemise").textContent=htApres.toFixed(2)+" â‚¬";
  document.getElementById("montantTVA").textContent=tvaVal.toFixed(2)+" â‚¬";
  document.getElementById("totalTTC").textContent=ttc.toFixed(2)+" â‚¬";
}

// SAVE
function saveDevis(){
  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({type:"devis",client:client.value,lignes:devis.lignes,remise:remise.value,tva:tva.value}),
    mode:"no-cors"
  });
  alert("Devis enregistrÃ©");
}

// VOICE
let recognition;

function startVocal(){

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "fr-FR";
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.start();

  recognition.onresult = e => {

    let text = e.results[e.results.length-1][0].transcript.toLowerCase();
    status.innerText = text;

    // =========================
    // CLIENT
    // =========================
    const clientMatch = text.match(/client\s+([a-zA-Z\s]+)/);
    if(clientMatch){
      const nom = clientMatch[1]
        .replace("monsieur","")
        .replace("madame","")
        .trim();
      client.value = nom;
    }

    // =========================
    // REMISE
    // =========================
    const remMatch = text.match(/remise\s*(\d+)/);
    if(remMatch) remise.value = remMatch[1];

    // =========================
    // TVA
    // =========================
    const tvaMatch = text.match(/tva\s*(\d+)/);
    if(tvaMatch) tva.value = tvaMatch[1];

    // =========================
    // LIGNES PAR "SUIVANT"
    // =========================
   const blocs = text.split("suivant");

blocs.forEach(bloc => {

  // rÃ©cupÃ¨re tous les nombres du bloc
  const numbers = bloc.match(/\d+/g);

  // rÃ©cupÃ¨re texte sans nombres
  const designation = bloc
    .replace(/\d+/g,"")
    .replace("Ã ","")
    .replace("a","")
    .trim();

  if(!designation) return;

  let quantite = 1;
  let prix = 0;

  if(numbers){
    if(numbers.length === 1){
      prix = numbers[0];
    }
    if(numbers.length >= 2){
      quantite = numbers[0];
      prix = numbers[1];
    }
  }

  devis.lignes.push({
    designation,
    quantite,
    prix
  });

});
    render();
  };
}

</script>
</body>
</html>



