<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Assistant Gestion</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f5f7fb}
.header{background:#2563eb;color:white;padding:20px;font-size:20px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:20px}
button{background:#2563eb;color:white;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;margin:5px}
input,select{padding:8px;margin:4px 0;width:100%}
.line{display:flex;gap:10px;align-items:center}
.deleteBtn{background:#ef4444}
.clearBtn{background:#f59e0b}
.saveBtn{background:#16a34a}
.totals{background:#f1f5f9;padding:15px;border-radius:8px;margin-top:10px}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">ğŸ“Š Assistant gestion</div>

<div class="container">

<!-- HOME -->
<div id="homePage" class="card">
<h3>Menu principal</h3>
<button onclick="showPage('devisPage')">ğŸ“„ CrÃ©er devis</button>
<button onclick="showPage('clientPage')">â• Ajouter client</button>
<button disabled>ğŸ§¾ CrÃ©er facture</button>
<button disabled>ğŸ“¦ CrÃ©er BL</button>
</div>

<!-- CLIENT -->
<div id="clientPage" class="card hidden">
<h3>Ajouter un client</h3>

<label>Nom</label>
<input id="c_nom">
<label>Adresse</label>
<input id="c_adresse">
<label>Email</label>
<input id="c_mail">
<label>TÃ©lÃ©phone</label>
<input id="c_tel">

<button class="saveBtn" onclick="saveClient()">ğŸ’¾ Enregistrer client</button>
<button onclick="showPage('homePage')">â¬…ï¸ Retour</button>
</div>

<!-- DEVIS -->
<div id="devisPage" class="card hidden">

<button onclick="showPage('homePage')">â¬…ï¸ Retour menu</button>

<h3>CrÃ©er un devis</h3>

<div class="card">
<button onclick="startVocal()">ğŸ¤ Micro</button>
<button onclick="stopVocal()">ğŸ›‘ Stop</button>
<p id="status"></p>
</div>

<label>Client</label>
<select id="client"></select>

<h3>Lignes</h3>
<div id="lines"></div>

<button onclick="addLine()">â• Ajouter ligne</button>
<button class="clearBtn" onclick="clearAll()">ğŸ§¹ Tout effacer</button>

<label>Remise (%)</label>
<input id="remise" oninput="calculate()">

<label>TVA (%)</label>
<input id="tva" oninput="calculate()">

<div class="totals">
<div>Total HT : <b id="totalHT">0 â‚¬</b></div>
<div>Montant remise : <b id="montantRemise">0 â‚¬</b></div>
<div>Total HT aprÃ¨s remise : <b id="totalApresRemise">0 â‚¬</b></div>
<div>Montant TVA : <b id="montantTVA">0 â‚¬</b></div>
<div>Total TTC : <b id="totalTTC">0 â‚¬</b></div>
</div>

<button class="saveBtn" onclick="saveDevis()">ğŸ’¾ Enregistrer devis</button>

</div>

</div>

<script>

// ===== URL WEB APP =====
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyy763BTRzWHbYDzuDJev1j8G4taqviqYqAcj8Q15vYR7USmiMGhpqAhq_fuv97P3qq/exec";

// ===== NAVIGATION =====
function showPage(id){
  homePage.classList.add("hidden");
  clientPage.classList.add("hidden");
  devisPage.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

// ===== SAVE CLIENT =====
function saveClient(){
  let payload={
    type:"client",
    nom:c_nom.value,
    adresse:c_adresse.value,
    mail:c_mail.value,
    tel:c_tel.value
  };

  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(()=>alert("âœ… Client ajoutÃ©"))
  .catch(()=>alert("âŒ Erreur rÃ©seau"));
}
// ===== DEVIS =====
let devis={lignes:[]};

function render(){
  lines.innerHTML="";
  devis.lignes.forEach((l,i)=>{
    lines.innerHTML+=`
      <div class="line">
        <input value="${l.designation}" oninput="devis.lignes[${i}].designation=this.value">
        <input type="number" value="${l.quantite}" oninput="devis.lignes[${i}].quantite=this.value;calculate()">
        <input type="number" value="${l.prix}" oninput="devis.lignes[${i}].prix=this.value;calculate()">
        <button class="deleteBtn" onclick="deleteLine(${i})">âœ–</button>
      </div>
    `;
  });
  calculate();
}

function addLine(){ devis.lignes.push({designation:"",quantite:1,prix:0}); render(); }
function deleteLine(i){ devis.lignes.splice(i,1); render(); }
function clearAll(){ devis={lignes:[]}; render(); }

// ===== CALCULS =====
function calculate(){
  let totalHT=0;
  devis.lignes.forEach(l=>totalHT+=Number(l.quantite||0)*Number(l.prix||0));

  let rem=Number(remise.value)||0;
  let montantRemise=totalHT*(rem/100);
  let totalApres=totalHT-montantRemise;

  let tv=Number(tva.value)||0;
  let montantTVA=totalApres*(tv/100);
  let totalTTC=totalApres+montantTVA;

  totalHTEl(totalHT);
  montantRemiseEl(montantRemise);
  totalApresRemiseEl(totalApres);
  montantTVAEl(montantTVA);
  totalTTCEl(totalTTC);
}

function totalHTEl(v){totalHT.textContent=v.toFixed(2)+" â‚¬";}
function montantRemiseEl(v){montantRemise.textContent=v.toFixed(2)+" â‚¬";}
function totalApresRemiseEl(v){totalApresRemise.textContent=v.toFixed(2)+" â‚¬";}
function montantTVAEl(v){montantTVA.textContent=v.toFixed(2)+" â‚¬";}
function totalTTCEl(v){totalTTC.textContent=v.toFixed(2)+" â‚¬";}

// ===== SAVE DEVIS =====
function saveDevis(){

  let payload={
    type:"devis",
    client:client.value,
    lignes:devis.lignes,
    remise:remise.value,
    tva:tva.value,
    totalHT:totalHT.textContent,
    totalTTC:totalTTC.textContent
  };

  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(res => res.text()) // ğŸ‘ˆ trÃ¨s important
  .then(txt => {
    console.log("RÃ©ponse serveur:", txt);
    alert("âœ… Devis envoyÃ© (vÃ©rifie la feuille)");
  })
  .catch(err => {
    console.error(err);
    alert("âŒ Erreur rÃ©seau");
  });
}
// ===== VOICE =====
let recognition;

function startVocal(){
  recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.lang="fr-FR";
  recognition.continuous=true;
  recognition.start();

  recognition.onresult=e=>{
    let text=e.results[e.results.length-1][0].transcript.toLowerCase();
    status.innerText=text;

    let clientMatch=text.match(/client\s+(.+)/);
    if(clientMatch){
      client.value=clientMatch[1].replace("monsieur","").replace("madame","").trim();
    }

    const regex=/(radiateur|chauffage|prestation|travaux)\D*(\d+)/g;
    let match;
    while((match=regex.exec(text))!==null){
      devis.lignes.push({designation:match[1],quantite:1,prix:match[2]});
    }

    let rem=text.match(/remise\s*(\d+)/);
    if(rem){remise.value=rem[1];}

    let tv=text.match(/tva\s*(\d+)/);
    if(tv){tva.value=tv[1];}

    render();
  };
}

function stopVocal(){ if(recognition) recognition.stop(); }

render();

</script>
</body>
</html>

